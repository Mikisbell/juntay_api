# ğŸ¦ MODELO CORREGIDO DE FLUJO DE CAJAS - JUNTAY

## ğŸ“‹ Documento de Referencia - MigraciÃ³n del Sistema

**Fecha**: 18 de Noviembre 2025  
**VersiÃ³n**: 2.0 (Modelo Bancario Correcto)  
**Estado**: Listo para migraciÃ³n

---

## ğŸ”„ CICLO COMPLETO DEL DINERO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GERENTE DE SEDE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  TRANSFERENCIA   â”‚     â”‚    EFECTIVO      â”‚
          â”‚ (Banco/YaPe/Plin)â”‚     â”‚   EN MANO        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   BÃ“VEDA CENTRAL          â”‚
                    â”‚ Saldo Total: $50,000      â”‚
                    â”‚ Disponible: $50,000       â”‚
                    â”‚ Asignado a Cajas: $0      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ASIGNACIÃ“N A CAJAS       â”‚
                    â”‚  (Gerente desconecta)     â”‚
                    â”‚  Caja #1: $10,000         â”‚
                    â”‚  Caja #2: $8,000          â”‚
                    â”‚  Caja #3: $7,000          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚                       â”‚            â”‚
  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
  â”‚ CAJA #1   â”‚â”‚ CAJA #2   â”‚ ....... â”‚ CAJA #N   â”‚â”‚ EMPLEADO  â”‚
  â”‚Empleado 1 â”‚â”‚Empleado 2 â”‚         â”‚Empleado N â”‚â”‚  1, 2, N  â”‚
  â”‚$10,000    â”‚â”‚$8,000     â”‚         â”‚$7,000     â”‚â”‚           â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚                       â”‚            â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                  â”‚
  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
  â”‚            OPERACIONES DEL DÃA                            â”‚
  â”‚  â€¢ PrÃ©stamos                                              â”‚
  â”‚  â€¢ RecepciÃ³n de pagos                                    â”‚
  â”‚  â€¢ Devoluciones de prendas                              â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
        â”‚                                                  â”‚
  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
  â”‚            CIERRE DE CAJA (Fin de Turno)                  â”‚
  â”‚  â€¢ Corte de caja                                          â”‚
  â”‚  â€¢ ConciliaciÃ³n de efectivo                              â”‚
  â”‚  â€¢ Reporte de movimientos                                â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
        â”‚                                                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                     â”‚                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”
        â”‚  DEVOLUCIÃ“N A BÃ“VEDA                            â”‚
        â”‚  Caja #1 devuelve: $9,200                       â”‚
        â”‚  Caja #2 devuelve: $7,800                       â”‚
        â”‚  Total devuelto: $17,000                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                     â”‚                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”
                    â”‚   BÃ“VEDA CENTRAL (Actualizada)    â”‚
                    â”‚ Saldo Total: $67,000              â”‚
                    â”‚ Disponible: $67,000               â”‚
                    â”‚ Asignado a Cajas: $0              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š TABLA DE DATOS CORREGIDA

### ANTES (âŒ INCORRECTO)
```
cajas_pesonales (CON TYPO)
â”œâ”€â”€ id
â”œâ”€â”€ usuario_id
â”œâ”€â”€ numero_caja
â”œâ”€â”€ estado (permanente)
â”œâ”€â”€ saldo_total
â””â”€â”€ fecha_ultima_actualizacion

Problema: No hay ciclo de apertura/cierre, confusiÃ³n con "personal"
```

### AHORA (âœ… CORRECTO)
```
cajas_operativas
â”œâ”€â”€ id
â”œâ”€â”€ usuario_id (Empleado que la opera)
â”œâ”€â”€ numero_caja
â”œâ”€â”€ estado (abierta/cerrada)
â”œâ”€â”€ saldo_inicial (Lo que gerente asigna)
â”œâ”€â”€ saldo_actual (Dinero presente)
â”œâ”€â”€ saldo_devuelto (Lo que se devuelve al cerrar)
â”œâ”€â”€ gerente_asigno_id (QuiÃ©n la abriÃ³)
â”œâ”€â”€ fecha_apertura (Inicio de turno)
â”œâ”€â”€ fecha_cierre (Fin de turno)
â””â”€â”€ observaciones

movimientos_caja_operativa (NUEVO)
â”œâ”€â”€ id
â”œâ”€â”€ caja_operativa_id
â”œâ”€â”€ tipo (asignacion_inicial, prestamo, pago_prestamo, devolucion_cierre, ajuste)
â”œâ”€â”€ monto
â”œâ”€â”€ saldo_anterior
â”œâ”€â”€ saldo_nuevo
â”œâ”€â”€ referencia_id (ID del crÃ©dito/pago)
â”œâ”€â”€ descripcion
â”œâ”€â”€ usuario_registro_id
â”œâ”€â”€ fecha
â””â”€â”€ metadata (JSONB - datos extra)

reportes_cierre_caja (NUEVO)
â”œâ”€â”€ id
â”œâ”€â”€ caja_operativa_id
â”œâ”€â”€ saldo_inicial
â”œâ”€â”€ total_prestamos
â”œâ”€â”€ total_pagos_recibidos
â”œâ”€â”€ total_devoluciones
â”œâ”€â”€ total_ajustes
â”œâ”€â”€ saldo_esperado
â”œâ”€â”€ saldo_real
â”œâ”€â”€ diferencia
â”œâ”€â”€ estado_cierre (conciliado, diferencia_menor, diferencia_mayor)
â”œâ”€â”€ generado_por_id
â”œâ”€â”€ fecha_generacion
â””â”€â”€ observaciones

movimientos_boveda_auditoria (MEJORADO)
â”œâ”€â”€ id
â”œâ”€â”€ boveda_id
â”œâ”€â”€ tipo (ingreso, asignacion_caja, devolucion_caja, ajuste)
â”œâ”€â”€ monto
â”œâ”€â”€ caja_operativa_id
â”œâ”€â”€ saldo_anterior
â”œâ”€â”€ saldo_nuevo
â”œâ”€â”€ usuario_id
â”œâ”€â”€ referencia
â”œâ”€â”€ fecha
â””â”€â”€ metadata
```

---

## ğŸ¯ PROCESOS OPERATIVOS

### 1ï¸âƒ£ INICIO DE DÃA - GERENTE ABRE CAJAS

```typescript
// FunciÃ³n: aperturaCajaOperativa
aperturaCajaOperativa({
  usuario_id: "emp_001",           // Empleado que abrirÃ¡ la caja
  numero_caja: 1,                  // Identificador
  saldo_inicial: 10000.00,         // Dinero que el gerente asigna
  gerente_id: "ger_001"            // QuiÃ©n abre
})

Resultado:
âœ“ Se crea registro en cajas_operativas
âœ“ Se registra movimiento en movimientos_caja_operativa (tipo: asignacion_inicial)
âœ“ Se actualiza boveda: saldo_disponible -10000, saldo_asignado +10000
âœ“ Se registra en movimientos_boveda_auditoria (tipo: asignacion_caja)
```

### 2ï¸âƒ£ DURANTE EL DÃA - EMPLEADO OPERA LA CAJA

**Ejemplo A: PrÃ©stamo**
```typescript
crearPrestamo({
  caja_operativa_id: "caja_001",
  cliente_id: "cli_001",
  monto: 1000.00,
  tasa: 20,
  frecuencia: "semanal"
})

Resultado:
âœ“ Se crea crÃ©dito con caja_operativa_id = "caja_001"
âœ“ Se registra movimiento (tipo: prestamo, monto: -1000)
âœ“ Saldo caja: $10,000 â†’ $9,000
```

**Ejemplo B: Pago de PrÃ©stamo**
```typescript
registrarPagoPrestamo({
  prestamo_id: "prestamo_001",
  caja_operativa_id: "caja_001",
  monto_pago: 200.00
})

Resultado:
âœ“ Se actualiza crÃ©dito (capital_pagado += 200)
âœ“ Se registra movimiento (tipo: pago_prestamo, monto: +200)
âœ“ Saldo caja: $9,000 â†’ $9,200
```

### 3ï¸âƒ£ CIERRE DE CAJA - EMPLEADO + GERENTE

```typescript
cierreCajaOperativa({
  caja_operativa_id: "caja_001",
  saldo_real: 9150.00,    // Lo que contÃ³ el empleado
  empleado_id: "emp_001",
  gerente_id: "ger_001"
})

Proceso interno:
1. Calcula saldo_esperado desde movimientos
2. Compara con saldo_real
3. Si diferencia < $5 â†’ estado_cierre = 'conciliado'
4. Si diferencia $5-50 â†’ estado_cierre = 'diferencia_menor' (investigar)
5. Si diferencia > $50 â†’ estado_cierre = 'diferencia_mayor' (reporte)
6. Registra en reportes_cierre_caja
7. Devuelve dinero a bÃ³veda

Resultado:
âœ“ cajas_operativas.estado = 'cerrada'
âœ“ cajas_operativas.saldo_devuelto = 9150.00
âœ“ cajas_operativas.fecha_cierre = NOW()
âœ“ Se registra movimiento (tipo: devolucion_cierre)
âœ“ BÃ³veda: saldo_disponible +9150, saldo_asignado -9150
âœ“ Reporte generado
```

---

## ğŸ” SEGURIDAD Y PERMISOS

| AcciÃ³n | Gerente | Empleado | Admin |
|--------|---------|----------|-------|
| **Crear Caja** | âœ… | âŒ | âœ… |
| **Abrir Caja** | âœ… | âŒ | âœ… |
| **Hacer PrÃ©stamos** | âœ… | âœ… (en su caja) | âœ… |
| **Recibir Pagos** | âœ… | âœ… (en su caja) | âœ… |
| **Cerrar Caja** | âœ… | âœ… (solo la propia) | âœ… |
| **Ver Reporte Cierre** | âœ… | âœ… (solo la propia) | âœ… |
| **Ver AuditorÃ­a BÃ³veda** | âœ… | âŒ | âœ… |
| **Hacer Ajustes** | âœ… | âŒ | âœ… |

---

## ğŸ“ˆ VISTAS Y REPORTES DISPONIBLES

### 1. `cajas_activas`
Muestra todas las cajas abiertas en este momento:
```
ID | Caja | Empleado | Saldo Inicial | Saldo Actual | Hora Apertura
```

### 2. `resumen_movimientos_caja`
Resumen de actividad de cada caja:
```
ID | Caja | Empleado | Total Movs | PrÃ©stamos | Pagos | Monto Prestado | Monto Pagado | Ãšltimo Movimiento
```

### 3. `reportes_cierre_caja`
Reportes finales con conciliaciÃ³n:
```
ID | Caja | Saldo Inicial | Total PrÃ©stamos | Total Pagos | Saldo Esperado | Saldo Real | Diferencia | Estado
```

---

## ğŸ“ CAMBIOS A REALIZAR EN SERVICIOS

### `bovedaService.ts`
```typescript
// ELIMINAR
- obtenerCajaPersonalPorUsuario()
- obtenerMovimientosCajaPersonal()
- crearCajaPersonal()
- solicitarEfectivoDeBoveda()
- devolverEfectivoABoveda()

// AGREGAR
+ aperturaCajaOperativa()        // Gerente abre caja
+ cierreCajaOperativa()          // Cierre de turno
+ obtenerCajasOperativasActivas() // Cajas abiertas
+ obtenerMovimientosCajaOperativa() // Historial
+ calcularSaldoCajaOperativa()   // Saldo actual
+ registrarMovimientoCaja()      // Registrar movimiento
+ obtenerReporteCierreCaja()     // Reporte de cierre
```

### `creditsService.ts`
```typescript
// MODIFICAR
- crearCreditoDesdeTasacion()
  CAMBIAR: tasacionId, clienteId, montoPrestamo
  POR: cajaOperativaId, tasacionId, clienteId, montoPrestamo

// AGREGAR
+ registrarPagoPrestamoDesdeCaja() // Pago desde caja operativa
```

---

## ğŸ—„ï¸ Ã“RDENES DE EJECUCIÃ“N SQL

1. Crear tabla `cajas_operativas`
2. Crear tabla `movimientos_caja_operativa`
3. Crear tabla `reportes_cierre_caja`
4. Mejorar tabla `movimientos_boveda_auditoria`
5. Agregar columnas a `creditos` (caja_operativa_id, tipo_prestamo)
6. Crear Ã­ndices
7. Crear RLS policies
8. Crear funciones helper
9. Crear vistas
10. âš ï¸ ELIMINAR tabla `cajas_pesonales` (HACER BACKUP PRIMERO)

---

## âœ… CHECKLIST DE IMPLEMENTACIÃ“N

- [ ] Ejecutar archivo SQL en Supabase
- [ ] Revisar que no haya errores
- [ ] Hacer backup de datos antiguos
- [ ] Actualizar `bovedaService.ts`
- [ ] Actualizar `creditsService.ts`
- [ ] Crear nuevos componentes React:
  - [ ] `aperturaCaja.tsx`
  - [ ] `operacionesCaja.tsx`
  - [ ] `cierreCaja.tsx`
  - [ ] `reporteCierreCaja.tsx`
- [ ] Actualizar layout de dashboard
- [ ] Pruebas E2E del flujo completo
- [ ] Deploy a producciÃ³n

---

## ğŸ“ NOTAS IMPORTANTES

1. **Backup**: Hacer backup de `cajas_pesonales` antes de migraciÃ³n
2. **MigraciÃ³n de datos**: Convertir datos antiguos a nuevo formato si es necesario
3. **Transacciones**: Usar transacciones para asegurar consistencia
4. **AuditorÃ­a**: Todo debe quedar registrado en movimientos_boveda_auditoria
5. **Reportes**: El cierre de caja es crÃ­tico - hacer validaciones exhaustivas

---

**VersiÃ³n**: 2.0  
**Estado**: ğŸŸ¢ Listo para implementar
