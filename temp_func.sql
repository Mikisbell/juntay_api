CREATE OR REPLACE FUNCTION public.crear_credito_completo(p_cliente_id uuid, p_monto_prestamo numeric, p_valor_tasacion numeric, p_tasa_interes numeric, p_periodo_dias integer, p_fecha_inicio timestamp with time zone, p_descripcion_garantia text, p_fotos text[], p_observaciones text DEFAULT NULL::text, p_usuario_id uuid DEFAULT NULL::uuid, p_caja_id uuid DEFAULT NULL::uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\nDECLARE\n    v_credito_id UUID;\n    v_garantia_id UUID;\n    v_codigo_credito TEXT;\n    v_interes NUMERIC;\n    v_total_pagar NUMERIC;\n    v_fecha_vencimiento TIMESTAMPTZ;\n    v_saldo_caja NUMERIC;\n    v_es_desembolso_inmediato BOOLEAN;\nBEGIN\n    -- ========================================\n    -- VALIDACIONES\n    -- ========================================\n    \n    -- 1. Monto mínimo y máximo (ACTUALIZADO: S/10)\n    IF p_monto_prestamo < 10 THEN\n        RAISE EXCEPTION 'El monto mínimo de préstamo es S/10';\n    END IF;\n    \n    IF p_monto_prestamo > 50000 THEN\n        RAISE EXCEPTION 'El monto máximo de préstamo es S/50,000. Contacte a gerencia.';\n    END IF;\n    \n    -- NOTA: No validamos que préstamo <= tasación\n    -- El tasador experto tiene flexibilidad para ajustar según su criterio profesional\n    \n    -- 3. Tasa de interés válida\n    IF p_tasa_interes < 1 OR p_tasa_interes > 50 THEN\n        RAISE EXCEPTION 'La tasa de interés debe estar entre 1%% y 50%%';\n    END IF;\n    \n    -- 4. Verificar que el cliente exista\n    IF NOT EXISTS (SELECT 1 FROM clientes WHERE id = p_cliente_id) THEN\n        RAISE EXCEPTION 'El cliente no existe';\n    END IF;\n    \n    -- ========================================\n    -- CÁLCULOS\n    -- ========================================\n    v_interes := p_monto_prestamo * (p_tasa_interes / 100);\n    v_total_pagar := p_monto_prestamo + v_interes;\n    v_fecha_vencimiento := p_fecha_inicio + (p_periodo_dias || ' days')::INTERVAL;\n    \n    -- Generar código único\n    v_codigo_credito := 'JT-' || TO_CHAR(NOW(), 'YYYYMMDD') || '-' || \n                        LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');\n    \n    -- Verificar caja si se proporciona\n    v_es_desembolso_inmediato := FALSE;\n    IF p_caja_id IS NOT NULL THEN\n        SELECT saldo_actual INTO v_saldo_caja\n        FROM cajas_operativas\n        WHERE id = p_caja_id AND estado = 'abierta';\n        \n        IF FOUND AND v_saldo_caja >= p_monto_prestamo THEN\n            v_es_desembolso_inmediato := TRUE;\n        END IF;\n    END IF;\n    \n    -- ========================================\n    -- INSERT CRÉDITO\n    -- ========================================\n    INSERT INTO creditos (\n        cliente_id,\n        codigo_credito,\n        monto_prestado,\n        tasa_interes,\n        interes_acumulado,\n        saldo_pendiente,\n        fecha_inicio,\n        fecha_vencimiento,\n        fecha_desembolso,\n        periodo_dias,\n        estado,\n        estado_detallado,\n        observaciones\n    ) VALUES (\n        p_cliente_id,\n        v_codigo_credito,\n        p_monto_prestamo,\n        p_tasa_interes,\n        v_interes,\n        v_total_pagar,\n        p_fecha_inicio,\n        v_fecha_vencimiento,\n        CASE WHEN v_es_desembolso_inmediato THEN p_fecha_inicio ELSE NULL END,\n        p_periodo_dias,\n        CASE WHEN v_es_desembolso_inmediato THEN 'vigente' ELSE 'pendiente' END,\n        CASE WHEN v_es_desembolso_inmediato THEN 'vigente' ELSE 'aprobado' END,\n        p_observaciones\n    )\n    RETURNING id INTO v_credito_id;\n    \n    -- ========================================\n    -- INSERT GARANTÍA\n    -- ========================================\n    INSERT INTO garantias (\n        credito_id,\n        descripcion,\n        valor_tasacion,\n        estado,\n        fotos\n    ) VALUES (\n        v_credito_id,\n        p_descripcion_garantia,\n        p_valor_tasacion,\n        'custodia_caja',\n        p_fotos\n    )\n    RETURNING id INTO v_garantia_id;\n    \n    -- Actualizar crédito con referencia a garantía\n    UPDATE creditos SET garantia_id = v_garantia_id WHERE id = v_credito_id;\n    \n    -- ========================================\n    -- MOVIMIENTO DE CAJA (si aplica)\n    -- ========================================\n    IF v_es_desembolso_inmediato THEN\n        INSERT INTO movimientos_caja_operativa (\n            caja_operativa_id,\n            tipo,\n            motivo,\n            monto,\n            referencia_id,\n            descripcion,\n            usuario_id,\n            saldo_anterior,\n            saldo_nuevo\n        ) VALUES (\n            p_caja_id,\n            'EGRESO',\n            'DESEMBOLSO_EMPENO',\n            p_monto_prestamo,\n            v_credito_id,\n            'Desembolso Crédito #' || v_codigo_credito,\n            p_usuario_id,\n            v_saldo_caja,\n            v_saldo_caja - p_monto_prestamo\n        );\n        \n        -- Actualizar saldo de caja\n        UPDATE cajas_operativas \n        SET saldo_actual = saldo_actual - p_monto_prestamo\n        WHERE id = p_caja_id;\n    END IF;\n    \n    -- ========================================\n    -- RETORNO\n    -- ========================================\n    RETURN json_build_object(\n        'success', TRUE,\n        'creditoId', v_credito_id,\n        'garantiaId', v_garantia_id,\n        'codigo', v_codigo_credito,\n        'estado', CASE WHEN v_es_desembolso_inmediato THEN 'DESEMBOLSADO' ELSE 'PENDIENTE_CAJA' END,\n        'monto', p_monto_prestamo,\n        'valorTasacion', p_valor_tasacion,\n        'tasaInteres', p_tasa_interes,\n        'interes', v_interes,\n        'totalPagar', v_total_pagar,\n        'fechaVencimiento', v_fecha_vencimiento,\n        'mensaje', CASE WHEN v_es_desembolso_inmediato \n            THEN '¡Crédito desembolsado!' \n            ELSE 'Crédito aprobado (pendiente desembolso)' \n        END\n    );\n    \nEXCEPTION\n    WHEN OTHERS THEN\n        -- Rollback automático por la transacción\n        RAISE EXCEPTION 'Error al crear crédito: %', SQLERRM;\nEND;\n$function$\n
